# ============================
# Promtail Deployment (Berlin)
# Pushes container logs to cloud Loki
# ============================

- name: Create Promtail directory
  ansible.builtin.file:
    path: /opt/promtail
    state: directory
    mode: '0755'
  become: yes
  delegate_to: berlin

- name: Create Promtail configuration
  ansible.builtin.copy:
    dest: /opt/promtail/promtail-config.yml
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: http://kaxtus.com:3100/loki/api/v1/push

      scrape_configs:
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: ['__meta_docker_container_name']
              regex: '/(.*)'
              target_label: 'container'
            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
              target_label: 'service'
            - target_label: 'host'
              replacement: 'berlin'
  delegate_to: berlin

- name: Stop existing Promtail container
  community.docker.docker_container:
    name: promtail-berlin
    state: absent
  ignore_errors: true
  delegate_to: berlin

- name: Start Promtail container
  community.docker.docker_container:
    name: promtail-berlin
    image: grafana/promtail:latest
    state: started
    restart_policy: unless-stopped
    volumes:
      - /opt/promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
  delegate_to: berlin
