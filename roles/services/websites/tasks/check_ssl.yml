- name: Filter SSL-enabled websites
  set_fact:
    websites_to_check: >-
      {{
        websites | dict2items |
        selectattr('value.ssl_enabled', 'defined') |
        selectattr('value.ssl_enabled', 'equalto', true) |
        list
      }}
  when: target_website is not defined

- name: Filter for target website only
  set_fact:
    websites_to_check: >-
      {{
        websites | dict2items |
        selectattr('key', 'equalto', target_website) |
        selectattr('value.ssl_enabled', 'defined') |
        selectattr('value.ssl_enabled', 'equalto', true) |
        list
      }}
  when: target_website is defined

- name: Check certificate expiry for each website
  shell: |
    cert_path="/etc/letsencrypt/live/{{ item.value.domains[0] }}/fullchain.pem"
    if [ -f "$cert_path" ]; then
      expiry_date=$(openssl x509 -enddate -noout -in "$cert_path" | cut -d= -f2)
      expiry_epoch=$(date -d "$expiry_date" +%s)
      now_epoch=$(date +%s)
      days_left=$(( (expiry_epoch - now_epoch) / 86400 ))
      if [ $days_left -le 0 ]; then
        echo "EXPIRED (expired {{ '${days_left#-}' }} days ago) - $expiry_date"
      elif [ $days_left -le 30 ]; then
        echo "EXPIRING SOON ($days_left days left) - $expiry_date"
      else
        echo "OK ($days_left days left) - $expiry_date"
      fi
    else
      echo "NO CERTIFICATE FOUND at $cert_path"
    fi
  become: yes
  loop: "{{ websites_to_check }}"
  register: cert_check_results
  changed_when: false

- name: Display certificate status
  debug:
    msg: "{{ item.item.key }} ({{ item.item.value.domains[0] }}): {{ item.stdout }}"
  loop: "{{ cert_check_results.results }}"
  loop_control:
    label: "{{ item.item.key }}"

- name: Summary of expired or expiring certificates
  debug:
    msg: >-
      ATTENTION: {{ item.item.key }} ({{ item.item.value.domains[0] }}) - {{ item.stdout }}
  loop: "{{ cert_check_results.results }}"
  loop_control:
    label: "{{ item.item.key }}"
  when: "'EXPIRED' in item.stdout or 'EXPIRING SOON' in item.stdout or 'NO CERTIFICATE' in item.stdout"

- name: Compare letsencrypt cert with nginx cert
  shell: |
    le_cert="/etc/letsencrypt/live/{{ item.value.domains[0] }}/fullchain.pem"
    nginx_cert="{{ nginx_host_ssl_path }}/{{ item.key }}/cert.pem"

    if [ ! -f "$le_cert" ]; then
      echo "MISSING - Let's Encrypt cert not found at $le_cert"
      exit 0
    fi

    if [ ! -f "$nginx_cert" ]; then
      echo "MISSING - Nginx cert not found at $nginx_cert"
      exit 0
    fi

    le_fingerprint=$(openssl x509 -noout -fingerprint -sha256 -in "$le_cert" 2>/dev/null)
    nginx_fingerprint=$(openssl x509 -noout -fingerprint -sha256 -in "$nginx_cert" 2>/dev/null)

    le_expiry=$(openssl x509 -noout -enddate -in "$le_cert" 2>/dev/null | cut -d= -f2)
    nginx_expiry=$(openssl x509 -noout -enddate -in "$nginx_cert" 2>/dev/null | cut -d= -f2)

    if [ "$le_fingerprint" = "$nginx_fingerprint" ]; then
      echo "MATCH - Both certs identical (expires: $le_expiry)"
    else
      echo "MISMATCH - Certs differ! LetsEncrypt expires: $le_expiry | Nginx expires: $nginx_expiry"
    fi
  become: yes
  loop: "{{ websites_to_check }}"
  register: cert_compare_results
  changed_when: false

- name: Display certificate comparison
  debug:
    msg: "{{ item.item.key }}: {{ item.stdout }}"
  loop: "{{ cert_compare_results.results }}"
  loop_control:
    label: "{{ item.item.key }}"

- name: Warn about certificate mismatches
  debug:
    msg: >-
      WARNING: {{ item.item.key }} - Nginx is serving a DIFFERENT certificate than Let's Encrypt generated!
      Run the SSL copy task to fix: ansible-playbook playbook.yml --tags websites:ssl
  loop: "{{ cert_compare_results.results }}"
  loop_control:
    label: "{{ item.item.key }}"
  when: "'MISMATCH' in item.stdout or 'MISSING' in item.stdout"