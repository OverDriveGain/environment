#!/bin/bash
# Automated certificate renewal script
# Generated by Ansible

set -e

echo "$(date): Starting certificate renewal"

# Renew certificates
/usr/bin/certbot renew --quiet --no-self-upgrade --webroot --webroot-path /var/www/letsencrypt

# Copy certificates to nginx directories
{% for site_name, site_config in websites.items() %}
{% if site_config.ssl_enabled | default(false) %}
if [ -f "/etc/letsencrypt/live/{{ site_config.domains[0] }}/fullchain.pem" ]; then
    /bin/cp /etc/letsencrypt/live/{{ site_config.domains[0] }}/fullchain.pem {{ nginx_host_ssl_path }}/{{ site_name }}/cert.pem
    /bin/cp /etc/letsencrypt/live/{{ site_config.domains[0] }}/privkey.pem {{ nginx_host_ssl_path }}/{{ site_name }}/key.pem
    echo "$(date): Copied certificates for {{ site_name }}"
fi
{% endif %}
{% endfor %}

# Reload nginx
/usr/bin/docker exec nginx-container nginx -s reload

echo "$(date): Certificate renewal completed"