- name: Get list of website configuration files
  ansible.builtin.find:
    paths: "{{ role_path }}/tasks/websites"
    patterns: "*.yml"
  register: website_files
  delegate_to: localhost

- name: Display found website configurations
  ansible.builtin.debug:
    msg: "Found website configuration: {{ item.path | basename }}"
  loop: "{{ website_files.files }}"

- name: Ensure websites_cloud_dir directory exists
  ansible.builtin.file:
    path: "{{ websites_cloud_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ host_username }}"
    group: "{{ host_username }}"
  become: no
  register: host_root_creation

- name: Include all website tasks
  ansible.builtin.include_tasks:
    apply:
      tags: 'website'
    file: "websites/{{ item.path | basename }}"
  loop: "{{ website_files.files }}"
  tags: 'website'
  vars:
    website: "{{ item.path | basename | regex_replace('\\.yml$', '') }}"