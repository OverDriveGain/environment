- name: Install and configure SSL certificates
  set_fact:
    certbot_auto_renew: yes
    lets_encrypt_staging: no

- name: Filter websites for SSL processing
  set_fact:
    websites_to_process: >-
      {{
        websites | dict2items |
        selectattr('value.ssl_enabled', 'defined') |
        selectattr('value.ssl_enabled', 'equalto', true) |
        list
      }}
  when: target_website is not defined

- name: Filter for target website only
  set_fact:
    websites_to_process: >-
      {{
        websites | dict2items |
        selectattr('key', 'equalto', target_website) |
        selectattr('value.ssl_enabled', 'defined') |
        selectattr('value.ssl_enabled', 'equalto', true) |
        list
      }}
  when: target_website is defined

- name: Display websites to process
  debug:
    msg: "Processing SSL for: {{ websites_to_process | map(attribute='key') | list }}"

- name: Install required packages
  apt:
    name:
      - certbot
      - python3-certbot
    state: present
    update_cache: yes
  become: yes
  when: websites_to_process | length > 0

- name: Create webroot directory for Let's Encrypt challenges
  file:
    path: /var/www/letsencrypt
    state: directory
    mode: '0755'
  become: no
  when: websites_to_process | length > 0

- name: Generate certificates for each website using webroot
  command: >
    certbot certonly --webroot
    --webroot-path /var/www/letsencrypt
    --email {{ item.value.ssl_email }}
    --cert-name {{ item.value.domains[0] }}
    {% for domain in item.value.domains %}
    -d {{ domain }}
    {% endfor %}
    --agree-tos
    --non-interactive
    --expand
    --keep-until-expiring
    {% if lets_encrypt_staging %}
    --staging
    {% endif %}
  become: yes
  loop: "{{ websites_to_process }}"
  register: cert_generation
  failed_when: false
  when: websites_to_process | length > 0

- name: Display certificate generation output
  debug:
    var: cert_generation
  when: websites_to_process | length > 0

- name: Make certificates readable
  file:
    path: "/etc/letsencrypt"
    mode: "0755"
    recurse: yes
  become: yes
  when: websites_to_process | length > 0

- name: Create SSL directories for each website in mounted directory
  file:
    path: "{{ nginx_host_ssl_path }}/{{ item.key }}"
    state: directory
    mode: '0755'
  loop: "{{ websites_to_process }}"
  become: yes
  when: websites_to_process | length > 0

- name: Copy fullchain.pem certificates to nginx directory
  copy:
    src: "/etc/letsencrypt/live/{{ item.value.domains[0] }}/fullchain.pem"
    dest: "{{ nginx_host_ssl_path }}/{{ item.key }}/cert.pem"
    remote_src: yes
    mode: "0644"
    follow: yes
  loop: "{{ websites_to_process }}"
  become: yes
  ignore_errors: yes
  when: websites_to_process | length > 0

- name: Copy privkey.pem certificates to nginx directory
  copy:
    src: "/etc/letsencrypt/live/{{ item.value.domains[0] }}/privkey.pem"
    dest: "{{ nginx_host_ssl_path }}/{{ item.key }}/key.pem"
    remote_src: yes
    mode: "0644"
    follow: yes
  loop: "{{ websites_to_process }}"
  become: yes
  ignore_errors: yes
  when: websites_to_process | length > 0

- name: Create certificate renewal script
  template:
    src: templates/certbot-renewal.sh.j2
    dest: /usr/local/bin/certbot-renewal.sh
    mode: '0755'
  become: yes
  when:
    - websites_to_process | length > 0
    - target_website is not defined  # Only create renewal script for full runs

- name: Set up automatic renewal with webroot
  cron:
    name: "Certbot Renewal"
    minute: "0"
    hour: "0"
    day: "12"
    job: "/usr/local/bin/certbot-renewal.sh >> /var/log/certbot-renewal.log 2>&1"
  when:
    - certbot_auto_renew
    - target_website is not defined  # Only set up cron for full runs

- name: Verify certificates
  command: >
    certbot certificates
  become: yes
  register: cert_status
  changed_when: false
  when: websites_to_process | length > 0

- name: Display certificate status
  debug:
    var: cert_status.stdout_lines
  when: websites_to_process | length > 0

- name: Display completion message for target website
  debug:
    msg: "SSL certificate processed for {{ target_website }}"
  when:
    - target_website is defined
    - websites_to_process | length > 0

- name: Display skip message if target website has no SSL
  debug:
    msg: "Target website {{ target_website }} does not have SSL enabled or does not exist"
  when:
    - target_website is defined
    - websites_to_process | length == 0