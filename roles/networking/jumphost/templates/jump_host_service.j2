[Unit]
Description=Jump host service enable access to this host from {{ jump_host_name }} on port {{ ssh_port }} to local port {{ local_ssh_port }}
After=network.target

[Service]
Environment="AUTOSSH_GATETIME=0"
Environment="AUTOSSH_DEBUG=1"
Environment="AUTOSSH_LOGLEVEL=7"

# Kill stale connection before starting (ignores errors with -)
ExecStartPre=-/usr/bin/ssh -i {{ ssh_key_dir }} -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" {{ jump_host_username }}@{{ jump_host_name }} "fuser -k {{ ssh_port }}/tcp || true"
ExecStartPre=/bin/sleep 2

ExecStart=/usr/bin/autossh -M 0 -v -i {{ ssh_key_dir }} -N -o "UserKnownHostsFile=/dev/null" -o "PubkeyAuthentication=yes" -o "StrictHostKeyChecking=no" -o "PasswordAuthentication=no" -o "ServerAliveInterval=60" -o "ServerAliveCountMax=3" -o "ExitOnForwardFailure=yes" -R {{ jump_host_name }}:{{ ssh_port }}:localhost:{{ local_ssh_port }} {{ jump_host_username }}@{{ jump_host_name }}

User={{ actual_user }}
Group={{ actual_user }}

Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target